From bd60de12be68565aedfad982e9256ed7b6155017 Mon Sep 17 00:00:00 2001
From: Mario Limonciello <mario.limonciello@dell.com>
Date: Wed, 11 Nov 2020 13:09:43 -0600
Subject: [PATCH] Add a flag to indicate if packages are supported

Anyone can easily add this, but it makes it clearer that by default hand
build, snap, and flatpak are not checked by anyone.
---
 contrib/PKGBUILD      |  2 +-
 contrib/fwupd.spec.in |  3 ++-
 meson.build           |  4 ++++
 meson_options.txt     |  1 +
 src/fu-tool.c         |  1 +
 src/fu-util-common.c  | 12 ++++++++++++
 src/fu-util-common.h  |  1 +
 src/fu-util.c         |  3 +++
 9 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/contrib/PKGBUILD b/contrib/PKGBUILD
index df332515..c3d3023f 100644
--- a/contrib/PKGBUILD
+++ b/contrib/PKGBUILD
@@ -27,7 +27,7 @@ build() {
     if [ -n "$CI" ]; then
         export CI="--wrap-mode=default"
     fi
-    arch-meson -D b_lto=false $CI ../build
+    arch-meson -D b_lto=false $CI ../build -Dsupported_build=true
 
     ninja -v -C ../build
 }
diff --git a/contrib/fwupd.spec.in b/contrib/fwupd.spec.in
index 591c86a2..7587fca9 100644
--- a/contrib/fwupd.spec.in
+++ b/contrib/fwupd.spec.in
@@ -246,7 +246,8 @@ can be flashed using flashrom. It is probably not required on servers.
 %else
     -Dplugin_modem_manager=false \
 %endif
-    -Dman=true
+    -Dman=true \
+    -Dsupported_build=true
 
 %meson_build
 
diff --git a/meson.build b/meson.build
index a6fb55dd..ef25c791 100644
--- a/meson.build
+++ b/meson.build
@@ -402,6 +402,10 @@ if build_standalone and get_option('consolekit')
   conf.set('HAVE_CONSOLEKIT' , '1')
 endif
 
+if get_option('supported_build')
+    conf.set('SUPPORTED_BUILD', '1')
+endif
+
 gnome = import('gnome')
 i18n = import('i18n')
 
diff --git a/meson_options.txt b/meson_options.txt
index 0a0e2853..f46cb7bc 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -22,6 +22,7 @@ option('plugin_modem_manager', type : 'boolean', value : false, description : 'e
 option('plugin_msr', type : 'boolean', value : true, description : 'enable MSR support')
 option('plugin_flashrom', type : 'boolean', value : false, description : 'enable libflashrom support')
 option('plugin_coreboot', type : 'boolean', value : true, description : 'enable coreboot support')
+option('supported_build', type : 'boolean', value : false, description: 'distribution package with upstream support')
 option('systemd', type : 'boolean', value : true, description : 'enable systemd support')
 option('systemd_root_prefix', type: 'string', value: '', description: 'Directory to base systemdâ€™s installation directories on')
 option('elogind', type : 'boolean', value : false, description : 'enable elogind support')
diff --git a/src/fu-tool.c b/src/fu-tool.c
index 46e4fefd..3c242b22 100644
--- a/src/fu-tool.c
+++ b/src/fu-tool.c
@@ -186,6 +186,7 @@ fu_util_start_engine (FuUtilPrivate *priv, FuEngineLoadFlags flags, GError **err
 			    fmt);
 	}
 	fu_util_show_plugin_warnings (priv);
+	fu_util_show_unsupported_warn ();
 	return TRUE;
 }
 
diff --git a/src/fu-util-common.c b/src/fu-util-common.c
index a687c46f..39b0338a 100644
--- a/src/fu-util-common.c
+++ b/src/fu-util-common.c
@@ -1995,3 +1995,15 @@ fu_util_switch_branch_warning (FwupdDevice *dev,
 	}
 	return TRUE;
 }
+
+void
+fu_util_show_unsupported_warn (void)
+{
+#ifndef SUPPORTED_BUILD
+	g_autofree gchar *fmt = NULL;
+	/* TRANSLATORS: this is a prefix on the console */
+	fmt = fu_util_term_format (_("WARNING:"), FU_UTIL_CLI_COLOR_YELLOW);
+	/* TRANSLATORS: unsupported build of the package */
+	g_printerr ("%s %s\n", fmt, _("This package has not been validated, it may not work properly."));
+#endif
+}
diff --git a/src/fu-util-common.h b/src/fu-util-common.h
index 35f3b21a..287178c5 100644
--- a/src/fu-util-common.h
+++ b/src/fu-util-common.h
@@ -118,3 +118,4 @@ gboolean	 fu_util_switch_branch_warning	(FwupdDevice	*dev,
 						 FwupdRelease	*rel,
 						 gboolean	 assume_yes,
 						 GError		**error);
+void		 fu_util_show_unsupported_warn	(void);
diff --git a/src/fu-util.c b/src/fu-util.c
index bc4c7a3c..7c12440a 100644
--- a/src/fu-util.c
+++ b/src/fu-util.c
@@ -3120,6 +3120,9 @@ main (int argc, char *argv[])
 	/* show user-visible warnings from the plugins */
 	fu_util_show_plugin_warnings (priv);
 
+	/* show any unsupported warnings */
+	fu_util_show_unsupported_warn ();
+
 	/* we know the runtime daemon version now */
 	fwupd_client_set_user_agent_for_package (priv->client, "fwupdmgr", PACKAGE_VERSION);
 
-- 
2.25.1

